<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <title>pleasereadbook</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="css/recommend.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">PleaseReadBook</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/mypage1.html">마이페이지</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/myclip.html">나의 리스트</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">고객센터</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          정렬기준
        </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" id="name" href="#">이름순</a>
            <a class="dropdown-item" id="rate" href="#">인기순</a>
            <a class="dropdown-item" id="time" href="#">독파순</a>
        </li>
      </ul>
      </div>
  </nav>

  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">번호</th>
        <th scope="col">제목</th>
        <th scope="col">저자</th>
        <th scope="col">평점</th>
        <th scope="col">독파 (단위: 시간)</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
  <button class="btn" id="login">로그인</button>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-messaging.js"></script>
  <script src="/js/fireinit.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      $('#login').click(function() {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function(result) {
          alert("로그인 성공");
        }).catch(function(error) {
          alert(error);
        });
      });

      $('#rate').click(function() {
        $('tbody>*').remove();
        var bookTitle;
        var bookAuthor;
        var bookRate;
        var bookTime;
        var ary = [];
        var book = {};
        var numBooks = 0;
        firebase.database().ref('/book').on('value', function(snapshot) {
          snapshot.forEach(function(childsnapshot) {
            firebase.database().ref('/book/' + childsnapshot.key).on('value', function(book) {
              bookTitle = book.val().title;
              bookAuthor = book.val().author;
              bookRate = book.val().rate;
              bookTime=book.val().time;

              book = {
                'title': bookTitle,
                'author': bookAuthor,
                'rate': bookRate,
                'time':bookTime
              };

              ary[numBooks++] = book;

            });
          });
        });
        heapSortRate(ary);

        var array_length;
        function heap_root(input, i) {
          var left = 2 * i + 1;
          var right = 2 * i + 2;
          var max = i;

          if ((left < array_length) && (input[left].rate > input[max].rate)) {
            max = left;
          }

          if ((right < array_length) && (input[right].rate > input[max].rate)) {
            max = right;
          }

          if (max != i) {
            swap(input, i, max);
            heap_root(input, max);
          }
        }

        function swap(input, index_A, index_B) {
          var temp = input[index_A];

          input[index_A] = input[index_B];
          input[index_B] = temp;
        }

        function heapSortRate(input) {

          array_length = input.length;

          for (var i = Math.floor(array_length / 2); i >= 0; i -= 1) {
            heap_root(input, i);
          }

          for (i = input.length - 1; i > 0; i--) {
            swap(input, 0, i);
            array_length--;
            heap_root(input, 0);
          }
        }

        for (var i = 0; i < ary.length; i++) {
          $('tbody').append("<tr><th>" + (i + 1) + "</th><td>" + ary[i].title + "</td><td>" + ary[i].author + "</td><td>" + ary[i].rate+"</td><td>" + ary[i].time+"</td></tr>");
        }
      });

      $('#time').click(function() {
        $('tbody>*').remove();
        var bookTitle;
        var bookAuthor;
        var bookRate;
        var bookTime;
        var ary = [];
        var book = {};
        var numBooks = 0;
        firebase.database().ref('/book').on('value', function(snapshot) {
          snapshot.forEach(function(childsnapshot) {
            firebase.database().ref('/book/' + childsnapshot.key).on('value', function(book) {
              bookTitle = book.val().title;
              bookAuthor = book.val().author;
              bookRate = book.val().rate;
              bookTime=book.val().time;

              book = {
                'title': bookTitle,
                'author': bookAuthor,
                'rate': bookRate,
                'time':bookTime
              };

              ary[numBooks++] = book;

            });
          });
        });
        heapSortTime(ary);
        for (var i = 0; i < ary.length; i++) {
          $('tbody').append("<tr><th>" + (i + 1) + "</th><td>" + ary[i].title + "</td><td>" + ary[i].author + "</td><td>" + ary[i].rate+"</td><td>" + ary[i].time+"</td></tr>");
        }
      });



      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          $('tbody').ready(function(){
            var bookTitle;
            var bookAuthor;
            var bookRate;
            var bookTime;
            var ary = [];
            var book = {};
            var numBooks = 0;
            firebase.database().ref('/book').on('value', function(snapshot) {
              snapshot.forEach(function(childsnapshot) {
                firebase.database().ref('/book/' + childsnapshot.key).on('value', function(book) {
                  bookTitle = book.val().title;
                  bookAuthor = book.val().author;
                  bookRate = book.val().rate;
                  bookTime=book.val().time;

                  book = {
                    'title': bookTitle,
                    'author': bookAuthor,
                    'rate': bookRate,
                    'time':bookTime
                  };

                  ary[numBooks++] = book;

                });
              });
            });

            for (var i = 0; i < ary.length; i++) {
              $('tbody').append("<tr><th>" + (i + 1) + "</th><td>" + ary[i].title + "</td><td>" + ary[i].author + "</td><td>" + ary[i].rate+"</td><td>" + ary[i].time+"</td></tr>");
            }
          });

        } else {
          alert(error);
        }
      });

    });
  </script>
  <!--script src="./js/sortByRate.js"></script-->
  <script src="./js/sortByTime.js"></script>
</body>

</html>
