<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <title>pleasereadbook</title>
  <link rel="stylesheet" type="text/css" href="css/recommend.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">PleaseReadBook</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="#">마이페이지</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">마이클립</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">고객센터</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          정렬기준
        </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" id="name" href="#">이름순</a>
            <a class="dropdown-item" id="rate" href="#">인기순</a>
            <a class="dropdown-item" id="time" href="#">독파순</a>
        </li>
      </ul>
      </div>
  </nav>

  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">번호</th>
        <th scope="col">제목</th>
        <th scope="col">저자</th>
        <th scope="col">평점</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn" id="login">로그인</button>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-messaging.js"></script>
  <script src="/js/fireinit.js"></script>

  <script type="text/javascript">
    $('#login').click(function() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).then(function(result) {
        alert("로그인 성공");
      }).catch(function(error) {
        alert(error);
      });
    });

    $('#rate').click(function () {
      $('tbody>*').remove();
      var bookTitle;
      var bookAuthor;
      var bookRate;
      var ary=[];
      var book = {};
      var numBooks = 0;
      firebase.database().ref('/book').on('value', function(snapshot) {
        snapshot.forEach(function(childsnapshot) {
          firebase.database().ref('/book/' + childsnapshot.key).on('value', function(book) {
            bookTitle = book.val().title;
            bookAuthor = book.val().author;
            bookRate = book.val().rate;

            book = {
              'title' : bookTitle,
              'author': bookAuthor,
              'rate' : bookRate
            };

            ary[numBooks++]=book;

          });
        });
      });


      //a=[ary[0].rate,ary[1].rate,ary[2].rate,ary[3].rate,ary[4].rate];

      heapSort(ary);
      for(i=0;i<ary.length;i++){
        $('tbody').append("<tr><th>"+(i+1)+"</th><td>" + ary[i].title + "</td><td>" + ary[i].author + "</td><td>" + ary[i].rate + "</td></tr>");
      }

    });



    //독파정렬

    /*$('#time').click(function sort_by_time() {
      firebase.database().ref('/book').on('value', function(snapshot) {
        snapshot.forEach(function(childsnapshot) {
          firebase.database().ref('/book' + childsnapshot.key).on('value', function(book) {
            var title = book.val().title;
            var author = book.val().author;
            var rate = book.val().rate;

          });

          alert(title);
          alert(author);
          alert(rate);

        });
      });
      //var a = [book1["time"], book2["time"], book3["time"], book4["time"], book5["time"]];
      var a = [title, author, rate, time];

      function swap(a, i, j) {
        var tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
      }

      function max_heapify(a, i, length) {
        while (true) {
          var left = i * 2 + 1;
          var right = i * 2 + 2;
          var largest = i;

          if (left < length && a[left] > a[largest]) {
            largest = left;
          }

          if (right < length && a[right] > a[largest]) {
            largest = right;
          }

          if (i == largest) {
            break;
          }

          swap(a, i, largest);
          i = largest;
        }
      }

      function heapify(a, length) {
        for (var i = Math.floor(length / 2); i >= 0; i--) {
          max_heapify(a, i, length);
        }
      }

      function heapsort(a) {
        heapify(a, a.length);

        for (var i = a.length - 1; i > 0; i--) {
          swap(a, i, 0);

          max_heapify(a, 0, i - 1);
        }
        $('tbody').append("<tr><th scope="
          row "><td>" + i + "</td><td>" + i + "</td><td>" + i + "</td></th></tr>");
        $('tbody').append("<tr><th scope="
          row "><td>" + i + "</td><td>" + i + "</td><td>" + i + "</td></th></tr>");
        $('tbody').append("<tr><th scope="
          row "><td>" + i + "</td><td>" + i + "</td><td>" + i + "</td></th></tr>");
        $('tbody').append("<tr><th scope="
          row "><td>" + i + "</td><td>" + i + "</td><td>" + i + "</td></th></tr>");
        $('tbody').append("<tr><th scope="
          row "><td>" + i + "</td><td>" + i + "</td><td>" + i + "</td></th></tr>");
      }

    });*/
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        alert("로그인 성공");
        var bookTitle;
        var bookAuthor;
        var bookRate;
        var ary=[];
        var book = {};
        var numBooks = 0;
        firebase.database().ref('/book').on('value', function(snapshot) {
          snapshot.forEach(function(childsnapshot) {
            firebase.database().ref('/book/' + childsnapshot.key).on('value', function(book) {
              bookTitle = book.val().title;
              bookAuthor = book.val().author;
              bookRate = book.val().rate;

              book = {
                'title' : bookTitle,
                'author': bookAuthor,
                'rate' : bookRate
              };

              ary[numBooks++]=book;

            });
          });
        });
      } else {
        alert(error);
      }
    });

    var array_length;
    function heap_root(input, i) {
      var left = 2 * i + 1;
      var right = 2 * i + 2;
      var max = i;

      if ((left < array_length) && (input[left].rate > input[max].rate)) {
        max = left;
      }

      if ((right < array_length) && (input[right].rate > input[max].rate)) {
        max = right;
      }

      if (max != i) {
        swap(input, i, max);
        heap_root(input, max);
      }
    }

    function swap(input, index_A, index_B) {
      var temp = input[index_A];

      input[index_A] = input[index_B];
      input[index_B] = temp;
    }

    function heapSort(input) {

      array_length = input.length;

      for (var i = Math.floor(array_length / 2); i >= 0; i -= 1) {
        heap_root(input, i);
      }

      for (i = input.length - 1; i > 0; i--) {
        swap(input, 0, i);
        array_length--;
        heap_root(input, 0);
      }
    }

  </script>

</body>

</html>
